<script>
    // Firebase configuration (same as before)
    const firebaseConfig = {
        apiKey: "AIzaSyAoGA6OqSZXZnRD471zOPyaBf6341NlYks",
        authDomain: "capstone-58ebe.firebaseapp.com",
        databaseURL: "https://capstone-58ebe-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "capstone-58ebe",
        storageBucket: "capstone-58ebe.appspot.com",
        messagingSenderId: "1046864472683",
        appId: "1:1046864472683:web:fdfa2bcb00d87a04db9f2e"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let autoMode = false;
    let manualIrrigate = false;

    // References for autoMode and manualIrrigate in the database
    const autoModeRef = database.ref('Control/autoMode');
    const manualIrrigateRef = database.ref('Control/manualIrrigate');
    const irrigationStatusRef = database.ref('Sensor/irrigation_status');
    const thresholdsRef = database.ref('Sensor/thresholds');
    const humidityRef = database.ref('Sensor/ldr_data');

    // Listen for autoMode changes from Firebase
    autoModeRef.on('value', (snapshot) => {
        autoMode = snapshot.val();
        updateButtonState();
        if (!autoMode) setIrrigation(false); // Turn off irrigation when auto is disabled
    });

    // Listen for manualIrrigate changes from Firebase
    manualIrrigateRef.on('value', (snapshot) => {
        manualIrrigate = snapshot.val();
        updateButtonState();
    });

    // Update button styles and states
    function updateButtonState() {
        const autoButton = document.getElementById("autoButton");
        const irrigateButton = document.getElementById("irrigateButton");

        autoButton.classList.toggle("on", autoMode);
        autoButton.classList.toggle("off", !autoMode);

        irrigateButton.classList.toggle("on", manualIrrigate && !autoMode);
        irrigateButton.classList.toggle("off", !(manualIrrigate && !autoMode));
    }

    // Handle "Auto" button click
    function toggleAuto() {
        autoMode = !autoMode;
        manualIrrigate = false; // Turn off manual irrigation when switching to auto

        // Update database values
        autoModeRef.set(autoMode);
        manualIrrigateRef.set(manualIrrigate);

        if (!autoMode) setIrrigation(false); // Turn off irrigation when auto is disabled
    }

    // Handle "Irrigate" button click
    function toggleIrrigate() {
        if (!autoMode) {
            manualIrrigate = !manualIrrigate;

            // Update database value
            manualIrrigateRef.set(manualIrrigate);

            setIrrigation(manualIrrigate);
        }
    }

    // Update irrigation status in the database
    function setIrrigation(status) {
        irrigationStatusRef.set(status);
    }

    // Humidity level and status handling (same as before)
    humidityRef.on('value', (snapshot) => {
        const humidity = snapshot.val();
        let status = "";
        let color = "";

        if (humidity <= dryMax) {
            status = "Dry";
            color = "brown";
            if (autoMode) setIrrigation(true);
        } else if (humidity > dryMax && humidity <= moistMax) {
            status = "Moist";
            color = "green";
            if (autoMode) setIrrigation(false);
        } else if (humidity > moistMax) {
            status = "Wet";
            color = "red";
            if (autoMode) setIrrigation(false);
        }

        const humidityElement = document.getElementById('humidity');
        humidityElement.innerText = `${humidity} (${status})`;
        humidityElement.style.color = color;
    });

    // Thresholds handling (same as before)
    thresholdsRef.on('value', (snapshot) => {
        const thresholds = snapshot.val();
        if (thresholds) {
            dryMax = thresholds.dryMax;
            moistMax = thresholds.moistMax;

            document.getElementById('displayDryMax').innerText = dryMax;
            document.getElementById('displayMoistMax').innerText = moistMax;
        }
    });

    function updateThresholds() {
        dryMax = parseInt(document.getElementById("dryMax").value);
        moistMax = parseInt(document.getElementById("moistMax").value);

        thresholdsRef.set({
            dryMax,
            moistMax
        });

        alert(`Thresholds updated:\nDry Max: ${dryMax}\nMoist Max: ${moistMax}`);
    }
</script>
